#!/usr/bin/env node
/**
 * Artillery JSON to HTML Report Generator
 * Creates self-contained HTML reports from Artillery JSON output
 */

const fs = require('fs');
const path = require('path');

function generateReport(jsonPath) {
  const data = JSON.parse(fs.readFileSync(jsonPath, 'utf8'));
  const name = path.basename(jsonPath, '.json');
  const aggregate = data.aggregate || {};
  const summaries = aggregate.summaries || {};
  const counters = aggregate.counters || {};

  // Determine if it's a WebSocket or HTTP test
  const isWebSocket = counters['socketio.emit'] !== undefined;

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artillery Report: ${name}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #c9d1d9; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { color: #58a6ff; margin-bottom: 10px; }
    h2 { color: #8b949e; font-size: 1.2em; margin: 20px 0 10px; border-bottom: 1px solid #21262d; padding-bottom: 5px; }
    .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
    .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 15px; }
    .card-title { color: #8b949e; font-size: 0.9em; margin-bottom: 5px; }
    .card-value { color: #58a6ff; font-size: 1.8em; font-weight: bold; }
    .card-unit { color: #6e7681; font-size: 0.8em; }
    .success { color: #3fb950; }
    .warning { color: #d29922; }
    .error { color: #f85149; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #21262d; }
    th { color: #8b949e; font-weight: 500; }
    td { color: #c9d1d9; }
    .metric-bar { background: #21262d; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
    .metric-fill { background: linear-gradient(90deg, #238636, #3fb950); height: 100%; border-radius: 4px; }
    .timestamp { color: #6e7681; font-size: 0.85em; margin-bottom: 20px; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 500; }
    .badge-success { background: #238636; color: #fff; }
    .badge-warning { background: #9e6a03; color: #fff; }
    .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #21262d; color: #6e7681; font-size: 0.85em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Artillery Load Test Report</h1>
    <p class="timestamp">Test: <strong>${name}</strong> | Generated: ${new Date().toISOString()}</p>

    <h2>Summary</h2>
    <div class="summary">
      ${isWebSocket ? generateWebSocketSummary(counters, summaries) : generateHttpSummary(counters, summaries)}
    </div>

    ${isWebSocket ? generateWebSocketDetails(counters, summaries) : generateHttpDetails(counters, summaries)}

    <div class="footer">
      <p>Generated by Artillery Load Test Suite | <a href="https://artillery.io" style="color: #58a6ff;">artillery.io</a></p>
      <p style="margin-top: 10px;"><a href="/api/reports/" style="color: #58a6ff;">‚Üê All Reports</a> ¬∑ <a href="/api/docs" style="color: #58a6ff;">API Docs</a> ¬∑ <a href="/api/async-docs" style="color: #58a6ff;">WebSocket Docs</a></p>
    </div>
  </div>
</body>
</html>`;

  const htmlPath = jsonPath.replace('.json', '.html');
  fs.writeFileSync(htmlPath, html);
  console.log(`‚úÖ Generated: ${htmlPath}`);
  return htmlPath;
}

function generateHttpSummary(counters, summaries) {
  const requests = counters['http.requests'] || 0;
  const responses = counters['http.responses'] || 0;
  const codes200 = counters['http.codes.200'] || 0;
  const codes201 = counters['http.codes.201'] || 0;
  const codes400 = counters['http.codes.400'] || 0;
  const codes401 = counters['http.codes.401'] || 0;
  const codes404 = counters['http.codes.404'] || 0;
  const codes409 = counters['http.codes.409'] || 0;
  const codes500 = counters['http.codes.500'] || 0;
  const vusersCompleted = counters['vusers.completed'] || 0;
  const vusersCreated = counters['vusers.created'] || 0;
  const vusersFailed = counters['vusers.failed'] || 0;

  const successRate = vusersCreated > 0 ? ((vusersCompleted / vusersCreated) * 100).toFixed(1) : 0;
  const responseTime = summaries['http.response_time'] || {};

  return `
    <div class="card">
      <div class="card-title">Total Requests</div>
      <div class="card-value">${requests.toLocaleString()}</div>
    </div>
    <div class="card">
      <div class="card-title">Success Rate (2xx)</div>
      <div class="card-value ${parseFloat(successRate) > 90 ? 'success' : parseFloat(successRate) > 70 ? 'warning' : 'error'}">${successRate}%</div>
      <div class="metric-bar"><div class="metric-fill" style="width: ${successRate}%"></div></div>
    </div>
    <div class="card">
      <div class="card-title">Mean Response Time</div>
      <div class="card-value">${(responseTime.mean || 0).toFixed(1)}<span class="card-unit">ms</span></div>
    </div>
    <div class="card">
      <div class="card-title">P95 Response Time</div>
      <div class="card-value">${(responseTime.p95 || 0).toFixed(1)}<span class="card-unit">ms</span></div>
    </div>
    <div class="card">
      <div class="card-title">P99 Response Time</div>
      <div class="card-value">${(responseTime.p99 || 0).toFixed(1)}<span class="card-unit">ms</span></div>
    </div>
    <div class="card">
      <div class="card-title">VUsers Completed</div>
      <div class="card-value">${vusersCompleted.toLocaleString()}<span class="card-unit">/ ${vusersCreated.toLocaleString()}</span></div>
    </div>
  `;
}

function generateWebSocketSummary(counters, summaries) {
  const emits = counters['socketio.emit'] || 0;
  const emitRate = counters['socketio.emit_rate'] || 0;
  const vusersCompleted = counters['vusers.completed'] || 0;
  const vusersCreated = counters['vusers.created'] || 0;
  const vusersFailed = counters['vusers.failed'] || 0;

  const successRate = vusersCreated > 0 ? ((vusersCompleted / vusersCreated) * 100).toFixed(1) : 0;
  const responseTime = summaries['socketio.response_time'] || {};

  return `
    <div class="card">
      <div class="card-title">Total Emits</div>
      <div class="card-value">${emits.toLocaleString()}</div>
    </div>
    <div class="card">
      <div class="card-title">Emit Rate</div>
      <div class="card-value">${emitRate.toLocaleString()}<span class="card-unit">/sec</span></div>
    </div>
    <div class="card">
      <div class="card-title">Success Rate</div>
      <div class="card-value ${parseFloat(successRate) > 90 ? 'success' : parseFloat(successRate) > 70 ? 'warning' : 'error'}">${successRate}%</div>
      <div class="metric-bar"><div class="metric-fill" style="width: ${successRate}%"></div></div>
    </div>
    <div class="card">
      <div class="card-title">Mean Latency</div>
      <div class="card-value">${(responseTime.mean || 0).toFixed(2)}<span class="card-unit">ms</span></div>
    </div>
    <div class="card">
      <div class="card-title">P99 Latency</div>
      <div class="card-value">${(responseTime.p99 || 0).toFixed(2)}<span class="card-unit">ms</span></div>
    </div>
    <div class="card">
      <div class="card-title">VUsers Completed</div>
      <div class="card-value">${vusersCompleted.toLocaleString()}<span class="card-unit">/ ${vusersCreated.toLocaleString()}</span></div>
    </div>
  `;
}

function generateHttpDetails(counters, summaries) {
  const codes = [
    ['200 OK', counters['http.codes.200'] || 0, 'success'],
    ['201 Created', counters['http.codes.201'] || 0, 'success'],
    ['400 Bad Request', counters['http.codes.400'] || 0, 'warning'],
    ['401 Unauthorized', counters['http.codes.401'] || 0, 'warning'],
    ['404 Not Found', counters['http.codes.404'] || 0, 'warning'],
    ['409 Conflict', counters['http.codes.409'] || 0, 'warning'],
    ['500 Server Error', counters['http.codes.500'] || 0, 'error'],
  ].filter(([_, count]) => count > 0);

  const responseTime = summaries['http.response_time'] || {};

  return `
    <h2>HTTP Status Codes</h2>
    <table>
      <tr><th>Status Code</th><th>Count</th><th>Percentage</th></tr>
      ${codes.map(([code, count, type]) => {
        const total = counters['http.responses'] || 1;
        const pct = ((count / total) * 100).toFixed(1);
        return `<tr><td><span class="${type}">${code}</span></td><td>${count.toLocaleString()}</td><td>${pct}%</td></tr>`;
      }).join('')}
    </table>

    <h2>Response Time Distribution</h2>
    <table>
      <tr><th>Metric</th><th>Value</th></tr>
      <tr><td>Min</td><td>${responseTime.min || 0}ms</td></tr>
      <tr><td>Max</td><td>${responseTime.max || 0}ms</td></tr>
      <tr><td>Mean</td><td>${(responseTime.mean || 0).toFixed(2)}ms</td></tr>
      <tr><td>Median (P50)</td><td>${responseTime.median || 0}ms</td></tr>
      <tr><td>P90</td><td>${responseTime.p90 || 0}ms</td></tr>
      <tr><td>P95</td><td>${responseTime.p95 || 0}ms</td></tr>
      <tr><td>P99</td><td>${responseTime.p99 || 0}ms</td></tr>
    </table>
  `;
}

function generateWebSocketDetails(counters, summaries) {
  const responseTime = summaries['socketio.response_time'] || {};
  const sessionLength = summaries['vusers.session_length'] || {};

  return `
    <h2>WebSocket Performance</h2>
    <table>
      <tr><th>Metric</th><th>Value</th></tr>
      <tr><td>Total Emits</td><td>${(counters['socketio.emit'] || 0).toLocaleString()}</td></tr>
      <tr><td>Emit Rate</td><td>${(counters['socketio.emit_rate'] || 0).toLocaleString()}/sec</td></tr>
      <tr><td>Min Latency</td><td>${responseTime.min || 0}ms</td></tr>
      <tr><td>Max Latency</td><td>${responseTime.max || 0}ms</td></tr>
      <tr><td>Mean Latency</td><td>${(responseTime.mean || 0).toFixed(3)}ms</td></tr>
      <tr><td>P95 Latency</td><td>${responseTime.p95 || 0}ms</td></tr>
      <tr><td>P99 Latency</td><td>${responseTime.p99 || 0}ms</td></tr>
    </table>

    <h2>Session Statistics</h2>
    <table>
      <tr><th>Metric</th><th>Value</th></tr>
      <tr><td>VUsers Created</td><td>${(counters['vusers.created'] || 0).toLocaleString()}</td></tr>
      <tr><td>VUsers Completed</td><td>${(counters['vusers.completed'] || 0).toLocaleString()}</td></tr>
      <tr><td>VUsers Failed</td><td>${(counters['vusers.failed'] || 0).toLocaleString()}</td></tr>
      <tr><td>Mean Session Length</td><td>${(sessionLength.mean || 0).toFixed(1)}ms</td></tr>
      <tr><td>P95 Session Length</td><td>${sessionLength.p95 || 0}ms</td></tr>
    </table>
  `;
}

function generateIndex(reports) {
  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artillery Load Test Reports</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #c9d1d9; line-height: 1.6; padding: 40px 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { color: #58a6ff; margin-bottom: 10px; font-size: 2em; }
    .subtitle { color: #8b949e; margin-bottom: 30px; }
    .reports { display: grid; gap: 15px; }
    .report-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; text-decoration: none; transition: border-color 0.2s, transform 0.2s; }
    .report-card:hover { border-color: #58a6ff; transform: translateY(-2px); }
    .report-title { color: #58a6ff; font-size: 1.2em; font-weight: 600; margin-bottom: 5px; }
    .report-type { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 500; margin-bottom: 10px; }
    .type-http { background: #388bfd20; color: #388bfd; }
    .type-ws { background: #3fb95020; color: #3fb950; }
    .report-desc { color: #8b949e; font-size: 0.9em; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #21262d; color: #6e7681; font-size: 0.85em; text-align: center; }
    a { color: #58a6ff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Artillery Load Test Reports</h1>
    <p class="subtitle">Telegram Gift Auction System - Performance Benchmarks</p>

    <div class="reports">
      ${reports.map(r => `
        <a href="${r.file}" class="report-card">
          <span class="report-type ${r.type === 'HTTP' ? 'type-http' : 'type-ws'}">${r.type}</span>
          <div class="report-title">${r.name}</div>
          <div class="report-desc">${r.desc}</div>
        </a>
      `).join('')}
    </div>

    <div class="footer">
      <p>Generated: ${new Date().toISOString()}</p>
      <p><a href="/api/docs">API Docs</a> ¬∑ <a href="/api/async-docs">WebSocket Docs</a> ¬∑ <a href="../BENCHMARK_REPORT.md">Benchmark Report</a></p>
    </div>
  </div>
</body>
</html>`;

  fs.writeFileSync(path.join(__dirname, 'index.html'), html);
  console.log('‚úÖ Generated: index.html');
}

// Main
const reportsDir = __dirname;
const jsonFiles = fs.readdirSync(reportsDir).filter(f => f.endsWith('.json'));

if (jsonFiles.length === 0) {
  console.log('No JSON files found in reports directory');
  process.exit(1);
}

console.log('üîÑ Generating HTML reports...\n');

const reports = [];
for (const file of jsonFiles) {
  const jsonPath = path.join(reportsDir, file);
  const htmlPath = generateReport(jsonPath);

  const isWs = file.includes('websocket');
  const name = file.replace('.json', '').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

  reports.push({
    file: path.basename(htmlPath),
    name: name,
    type: isWs ? 'WebSocket' : 'HTTP',
    desc: getDescription(file)
  });
}

// Generate index page
generateIndex(reports);

console.log('\n‚ú® All reports generated successfully!');

function getDescription(file) {
  const descs = {
    'load-test.json': 'Standard HTTP load test with multiple user journeys and bid scenarios',
    'edge-cases.json': 'Validation testing for error handling, auth, and edge cases',
    'websocket-standard.json': 'Standard WebSocket/Socket.IO connection and bid flow testing',
    'websocket-stress.json': 'High-throughput WebSocket stress test (11K+ emit/sec)',
    'websocket-extreme.json': 'Extreme WebSocket load test pushing limits (118K+ emit/sec peak)'
  };
  return descs[file] || 'Artillery load test report';
}
