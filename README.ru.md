# Система аукционов Telegram Gift

Многораундовый аукцион-бэкенд для цифровых коллекционных предметов, вдохновленный аукционами подарков Telegram.

**Демо:** [https://telegram-gift-auction.funfiesta.games](https://telegram-gift-auction.funfiesta.games)

**API Документация:** [https://telegram-gift-auction.funfiesta.games/api/docs](https://telegram-gift-auction.funfiesta.games/api/docs)

[English version](./README.md)

## Анализ продукта: Как работают аукционы подарков Telegram

### Механика аукционов Telegram

Telegram проводит аукционы лимитированных цифровых подарков. В отличие от традиционных аукционов с одним дедлайном, это **многораундовая система с выбыванием**:

1. **Несколько раундов**: Аукцион состоит из нескольких раундов (например, 3 раунда для 10 предметов: 3+5+2)
2. **Частичные победители в раунде**: В конце каждого раунда топ N участников выигрывают предметы
3. **Проигравшие продолжают**: Не победившие сохраняют ставки и участвуют в следующих раундах
4. **Анти-снайпинг**: Ставки в последние секунды продлевают раунд для честной конкуренции
5. **Одна ставка на пользователя**: У каждого пользователя ОДНА ставка, которую можно только увеличить

### Ключевые механики

| Аспект | Поведение |
|--------|-----------|
| **Модель ставок** | Одна ставка на пользователя на аукцион (только увеличение) |
| **Ранжирование** | Выигрывает наибольшая ставка; при равенстве — более ранняя по времени |
| **Выбор победителей** | Топ N участников в конце раунда (N = предметов в раунде) |
| **Движение средств** | Сумма ставки замораживается немедленно; списывается при победе, возвращается при проигрыше |
| **Переход раундов** | Автоматический; проигравшие переносятся с текущей ставкой |
| **Анти-снайпинг** | Ставки в последние минуты продлевают раунд |

---

## Архитектура

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Frontend (React + Vite)                      │
│  - Список и детали аукционов    - Обновления ставок в реальном времени│
│  - Размещение/увеличение ставок - Управление балансом               │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Backend (NestJS + Fastify)                      │
│                                                                      │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌──────────────┐  │
│  │  REST API  │  │  WebSocket │  │  Scheduler │  │    Guards    │  │
│  │ (Fastify)  │  │ (Socket.IO)│  │   (Cron)   │  │ (Auth/Rate)  │  │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └──────┬───────┘  │
│        │               │               │                 │          │
│        ▼               ▼               ▼                 ▼          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      Сервисный слой                          │  │
│  │                                                               │  │
│  │  AuctionsService          UsersService         BotService    │  │
│  │  ├─ placeBid()            ├─ deposit()         ├─ simulate() │  │
│  │  ├─ completeRound()       ├─ withdraw()        └─ bid()      │  │
│  │  ├─ antiSniping()         └─ getBalance()                    │  │
│  │  └─ getLeaderboard()                                         │  │
│  │                                                               │  │
│  │  TransactionsService      EventsGateway                      │  │
│  │  ├─ recordTransaction()   ├─ emitNewBid()                    │  │
│  │  └─ getHistory()          ├─ emitRoundComplete()             │  │
│  │                           └─ emitAntiSniping()               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                    │                                │
└────────────────────────────────────┼────────────────────────────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              ▼                      ▼                      ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────┐
│       MongoDB       │  │        Redis        │  │                 │
│                     │  │                     │  │                 │
│  users              │  │  Распределённые     │  │    WebSocket    │
│  ├─ balance         │  │  блокировки         │  │    Клиенты      │
│  └─ frozenBalance   │  │  (Redlock)          │  │                 │
│                     │  │                     │  │                 │
│  auctions           │  │  Кулдаун ставок     │  │                 │
│  ├─ roundsConfig[]  │  │  (на пользователя)  │  │                 │
│  └─ rounds[]        │  └─────────────────────┘  └─────────────────┘
│                     │
│  bids               │
│  ├─ amount          │
│  └─ status          │
│                     │
│  transactions       │
│  └─ аудит           │
└─────────────────────┘
```

### Технологический стек

| Компонент | Технология |
|-----------|------------|
| Среда выполнения | Node.js 22+ |
| Язык | TypeScript (strict) |
| Фреймворк | NestJS 11 с Fastify |
| База данных | MongoDB 8.2+ (replica set) |
| Кэш/Блокировки | Redis + Redlock |
| Реальное время | Socket.IO |
| Аутентификация | JWT (Bearer token) |
| Валидация | class-validator, Joi |

---

## Как это работает

### 1. Жизненный цикл аукциона

```
PENDING ──[старт]──► ACTIVE ──[раунды завершены]──► COMPLETED
                        │
                        ├── Раунд 1: Топ 3 выигрывают предметы #1-3
                        ├── Раунд 2: Топ 5 выигрывают предметы #4-8
                        └── Раунд 3: Топ 2 выигрывают предметы #9-10
                                     │
                                     └── Оставшиеся ставки возвращаются
```

### 2. Размещение ставки

```typescript
// Пользователь размещает ставку 1000
POST /api/auctions/:id/bid { amount: 1000 }

// Последовательность системы:
1. Получение распределённой блокировки (Redlock) → предотвращает конкурентные ставки
2. Проверка кулдауна в Redis → предотвращает быстрые ставки подряд
3. Начало MongoDB транзакции (snapshot isolation)
4. Валидация: аукцион активен, раунд не завершён, достаточно средств
5. Заморозка средств: balance -= 1000, frozenBalance += 1000
6. Создание/обновление записи ставки
7. Проверка анти-снайпинга: продление раунда если в окне
8. Коммит транзакции
9. Установка кулдауна в Redis
10. Освобождение блокировки
11. Отправка WebSocket события
```

### 3. Финансовая модель

```
Баланс пользователя:
  ├── balance (доступно для ставок)
  └── frozenBalance (заблокировано в активных ставках)

Инвариант: Общая стоимость = balance + frozenBalance + потрачено на победы

Жизненный цикл ставки:
  Размещение:  balance -= amount,  frozenBalance += amount
  Победа:      frozenBalance -= amount  (деньги потрачены)
  Возврат:     frozenBalance -= amount, balance += amount (деньги возвращены)
```

### 4. Механизм анти-снайпинга

```
Конец раунда: 10:00:00
Окно анти-снайпинга: 5 минут
Продление: 5 минут
Макс. продлений: 6

Таймлайн:
  09:54:59 - Ставка → Без продления (вне окна)
  09:55:01 - Ставка → Раунд продлён до 10:05:00 (продление #1)
  10:04:30 - Ставка → Раунд продлён до 10:10:00 (продление #2)
  ... до 6 продлений максимум
```

### 5. Определение победителей

```typescript
// В конце раунда:
const bids = await Bid.find({ status: 'active' })
  .sort({ amount: -1, createdAt: 1 });  // Наибольшая сумма, раннее время

const winners = bids.slice(0, itemsInRound);
const losers = bids.slice(itemsInRound);

// Победители: bid.status = 'won', frozenBalance списывается
// Проигравшие: продолжают в следующем раунде (или возврат в последнем)
```

---

## Обработка конкурентности и race condition

Система обрабатывает экстремальную конкурентность через несколько уровней:

### Уровень 1: Распределённые блокировки (Redis + Redlock)

```typescript
// Только один запрос на пользователя на аукцион может выполняться
const lock = await redlock.acquire([`bid-lock:${userId}:${auctionId}`], 10000);
try {
  // Обработка ставки
} finally {
  await lock.release();
}
```

- **Режим fail-fast**: Конкурентные запросы сразу отклоняются (без ожидания)
- **TTL защита**: Блокировка автоматически истекает через 10 секунд

### Уровень 2: Redis кулдаун

```typescript
// После успешной ставки устанавливаем кулдаун 1 секунда
await redis.set(`bid-cooldown:${userId}:${auctionId}`, '1', 'PX', 1000);

// Последующие запросы в течение 1 секунды отклоняются
if (await redis.exists(cooldownKey)) {
  throw new ConflictException('Подождите перед следующей ставкой');
}
```

### Уровень 3: MongoDB транзакции

```typescript
session.startTransaction({
  readConcern: { level: 'snapshot' },  // Консистентные чтения
  writeConcern: { w: 'majority' },     // Надёжные записи
});
```

- **Snapshot isolation**: Транзакция видит консистентные данные с начала
- **Автоматический retry**: Transient ошибки вызывают повтор с экспоненциальной задержкой

### Уровень 4: Оптимистичная блокировка

```typescript
// Обновление баланса с проверкой версии
await User.findOneAndUpdate(
  { _id: userId, version: user.version },
  { $inc: { balance: -amount, version: 1 } }
);

// Обновление ставки с проверкой версии
await Bid.findOneAndUpdate(
  { _id: bidId, __v: originalVersion },
  { amount: newAmount, $inc: { __v: 1 } }
);
```

### Уровень 5: Уникальные индексы базы данных

```typescript
// Только одна активная ставка на пользователя на аукцион
BidSchema.index(
  { auctionId: 1, userId: 1 },
  { unique: true, partialFilterExpression: { status: 'active' } }
);

// Только одна ставка с каждой суммой на аукцион
BidSchema.index(
  { auctionId: 1, amount: 1 },
  { unique: true, partialFilterExpression: { status: 'active' } }
);
```

---

## API справочник

### Аутентификация

Все защищённые эндпоинты требуют заголовок `Authorization: Bearer <token>`.

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/auth/login` | POST | Вход/регистрация (возвращает JWT) |
| `/api/auth/logout` | POST | Выход |
| `/api/auth/me` | GET | Получить текущего пользователя |

### Пользователи

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/users/balance` | GET | Получить баланс (доступный + замороженный) |
| `/api/users/deposit` | POST | Пополнить |
| `/api/users/withdraw` | POST | Вывести средства |

### Аукционы

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/auctions` | GET | Список аукционов |
| `/api/auctions` | POST | Создать аукцион |
| `/api/auctions/:id` | GET | Детали аукциона |
| `/api/auctions/:id/start` | POST | Запустить аукцион |
| `/api/auctions/:id/bid` | POST | Сделать или увеличить ставку |
| `/api/auctions/:id/leaderboard` | GET | Текущий рейтинг |
| `/api/auctions/:id/my-bids` | GET | Ставки пользователя |

### Транзакции

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/transactions` | GET | История транзакций |

### WebSocket события

**Клиент → Сервер:**
- `join-auction` - Подписка на обновления аукциона
- `leave-auction` - Отписка

**Сервер → Клиент:**
- `new-bid` - Новая ставка
- `auction-update` - Изменение состояния аукциона
- `anti-sniping` - Раунд продлён
- `round-complete` - Раунд завершён с победителями
- `auction-complete` - Аукцион завершён

**Восстановление соединения:**
- Сессии сохраняются 2 минуты после отключения
- Автоматический rejoin в комнату при переподключении
- Пропущенные события доставляются при восстановлении
- Работает на Socket.IO + Redis адаптере

---

## Нагрузочное тестирование

Система включает комплексный набор нагрузочных тестов.

### Запуск тестов

```bash
cd backend
npx ts-node src/scripts/load-test.ts
```

### Тестовые сценарии

| Тест | Что проверяет | Ожидаемый результат |
|------|---------------|---------------------|
| **Concurrent Bid Storm** | 20 пользователей одновременно | Все ставки обработаны |
| **Rapid Sequential Bids** | 20 быстрых последовательных ставок | Все успешны |
| **Tie-Breaking** | 10 пользователей с одной суммой | Только 1 побеждает (ранняя метка) |
| **High-Frequency Stress** | 75 ставок rapid-fire | Высокий % успеха |
| **Massive Concurrent** | 60 одновременных запросов | Все обработаны корректно |
| **Insufficient Funds** | Ставка без баланса | Отклонено с 400 |
| **Invalid Bid** | Отрицательные/нулевые суммы | Отклонено с 400 |
| **Auth Validation** | Неверный/отсутствующий токен | Отклонено с 401 |
| **Same-User Race** | 10 конкурентных ставок от 1 пользователя | Только 3-5 успешны |
| **Bid Ordering** | Проверка порядка в таблице лидеров | Корректный рейтинг |
| **Financial Integrity** | Проверка сохранности средств | Уравнение баланса выполняется |

### Пример вывода

```
══════════════════════════════════════════════════
       AUCTION SYSTEM LOAD TEST SUITE
══════════════════════════════════════════════════

✓ Concurrent Bid Storm: 20/20 succeeded @ 35.3 req/s
✓ Rapid Sequential Bids: 20/20 succeeded, avg=13ms
✓ Tie-Breaking (Same Amount): 1 winner from 10 identical bids
✓ High-Frequency Stress: 75 bids @ 14.9 req/s
✓ Massive Concurrent Stress: 60/60 @ 16.3 req/s
✓ Insufficient Funds Rejection: 5/5 correctly rejected
✓ Invalid Bid Rejection: 4/4 rejected
✓ Auth Validation: InvalidToken=401, NoAuth=401
✓ Same-User Race Condition: 4/10 succeeded (expected ≤5)
✓ Bid Ordering Verification: ordering=correct
✓ Financial Integrity: VALID (diff=0.00)

══════════════════════════════════════════════════
  ALL 11 TESTS PASSED
══════════════════════════════════════════════════
```

---

## Быстрый старт

**Сначала настройте файлы окружения:**

```bash
cp backend/.env.example backend/.env
cp frontend/.env.example frontend/.env
```

### Вариант 1: Docker Compose (Рекомендуется)

```bash
docker compose up --build

# Доступ:
# - Frontend: http://localhost:5173
# - Backend API: http://localhost:3001/api
# - Swagger Docs: http://localhost:3001/api/docs
```

### Вариант 2: Локальная разработка

```bash
# 1. Запустить инфраструктуру (MongoDB + Redis)
docker compose -f docker-compose.infra.yml up -d

# 2. Установить зависимости и запустить
npm install
npm run dev

# Или запустить отдельно:
npm run dev:backend   # http://localhost:3001
npm run dev:frontend  # http://localhost:5173
```

### Вариант 3: Ручная настройка

**Требования:**
- Node.js 22+
- MongoDB 8.2+ (с replica set)
- Redis 7+

```bash
# Backend
cd backend
npm install
npm run start:dev

# Frontend (в другом терминале)
cd frontend
npm install
npm run dev
```

---

## Конфигурация

### Переменные окружения Backend (`backend/.env`)

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `PORT` | Порт сервера | 3001 |
| `MONGODB_URI` | Строка подключения MongoDB | mongodb://localhost:27017/auction |
| `REDIS_URL` | Строка подключения Redis | redis://localhost:6379 |
| `JWT_SECRET` | Секрет для подписи JWT | (обязателен в продакшене) |
| `CORS_ORIGIN` | Разрешённый CORS origin | http://localhost:5173 |
| `THROTTLE_TTL` | Окно rate limit (мс) | 60000 |
| `THROTTLE_LIMIT` | Макс. запросов в окне | 300 |

### Переменные окружения Frontend (`frontend/.env`)

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `VITE_API_URL` | URL Backend API | http://localhost:3001/api |
| `VITE_SOCKET_URL` | URL WebSocket сервера | http://localhost:3001 |

### Rate Limiting

Три уровня на IP адрес:
- **Short**: 20 запросов/секунду
- **Medium**: 100 запросов/10 секунд
- **Long**: 300 запросов/минуту

Localhost (`127.0.0.1`, `::1`) обходит rate limiting для разработки.

---

## Структура проекта

```
.
├── backend/
│   ├── src/
│   │   ├── common/
│   │   │   ├── errors/              # Type guards для ошибок MongoDB
│   │   │   ├── guards/              # Auth & throttle guards
│   │   │   └── types/               # Общие TypeScript интерфейсы
│   │   ├── config/
│   │   │   ├── configuration.ts     # Загрузчик конфигурации
│   │   │   └── env.validation.ts    # Joi схема для валидации env
│   │   ├── modules/
│   │   │   ├── auctions/
│   │   │   │   ├── auctions.service.ts        # Логика ставок/раундов
│   │   │   │   ├── auctions.controller.ts     # REST эндпоинты
│   │   │   │   ├── auction-scheduler.service.ts  # Cron для завершения раундов
│   │   │   │   ├── bot.service.ts             # Симуляция ботов
│   │   │   │   └── dto/                       # Request/response DTO
│   │   │   ├── auth/                # JWT аутентификация
│   │   │   ├── bids/                # Запросы ставок
│   │   │   ├── events/              # WebSocket gateway (Socket.IO)
│   │   │   ├── redis/               # Redis клиент + Redlock
│   │   │   ├── transactions/        # Финансовый аудит
│   │   │   └── users/               # Управление пользователями и балансом
│   │   ├── schemas/
│   │   │   ├── auction.schema.ts    # Аукцион + раунды
│   │   │   ├── bid.schema.ts        # Ставки с уникальными индексами
│   │   │   ├── user.schema.ts       # Баланс + frozenBalance
│   │   │   └── transaction.schema.ts # Журнал аудита
│   │   ├── scripts/
│   │   │   └── load-test.ts         # Комплексное нагрузочное тестирование
│   │   ├── app.module.ts            # Корневой модуль
│   │   └── main.ts                  # Точка входа
│   ├── test/                        # E2E тесты
│   ├── Dockerfile
│   └── .env.example
├── frontend/
│   ├── src/
│   │   ├── api/                     # API клиент
│   │   ├── components/              # UI компоненты
│   │   ├── context/                 # Auth & notification провайдеры
│   │   ├── hooks/                   # useSocket, useCountdown
│   │   ├── pages/
│   │   │   ├── AuctionsPage.tsx     # Список аукционов
│   │   │   ├── AuctionPage.tsx      # Просмотр аукциона
│   │   │   ├── CreateAuctionPage.tsx
│   │   │   ├── LoginPage.tsx
│   │   │   └── TransactionsPage.tsx
│   │   ├── types/                   # TypeScript интерфейсы
│   │   ├── App.tsx                  # Настройка роутера
│   │   └── main.tsx                 # Точка входа
│   ├── Dockerfile
│   └── .env.example
├── docker-compose.yml               # Полный стек (MongoDB, Redis, Backend, Frontend)
├── docker-compose.infra.yml         # Только инфраструктура (MongoDB, Redis)
├── package.json                     # Workspace root
└── README.md
```

---

## Дизайн-решения

### Почему MongoDB транзакции?
Финансовые операции требуют атомарности. Если списание баланса успешно, а создание ставки нет — система теряет деньги. Транзакции обеспечивают "всё или ничего".

### Почему Redis + Redlock?
MongoDB транзакции обрабатывают конкурентность на уровне базы, но не предотвращают отправку 10 конкурентных HTTP запросов одним пользователем. Redlock обеспечивает распределённую блокировку на уровне приложения.

### Почему Fastify вместо Express?
Fastify даёт 2-3x лучшую пропускную способность и нативную поддержку TypeScript. Критично для сценариев с высокой конкурентностью.

### Почему запланированное завершение раундов?
Cron-задача проверяет истёкшие раунды каждые 5 секунд. Это гарантирует завершение раундов даже без подключённых клиентов и корректно обрабатывает перезапуски сервера.

### Почему уникальные суммы ставок?
Одинаковые суммы ставок создают неоднозначность в рейтинге. Уникальные суммы (на аукцион) делают таблицу лидеров всегда детерминированной.

---

## Обработанные краевые случаи

| Краевой случай | Решение |
|----------------|---------|
| Ставка в момент конца раунда | Буфер 100мс перед дедлайном отклоняет "слишком близкие" ставки |
| Ставка во время перехода раунда | Изоляция транзакции предотвращает устаревшие чтения |
| Падение сервера во время ставки | MongoDB транзакция откатывается; Redis блокировка истекает |
| 10 конкурентных ставок от одного пользователя | Redlock обеспечивает выполнение только 1; остальные fail fast |
| Race condition одинаковых сумм | Уникальный индекс + семантика first-write-wins |
| Баланс уходит в минус | MongoDB валидация схемы (`min: 0`) + атомарная проверка `$gte` |
| Раунд завершается без ставок | Корректный переход к следующему раунду или завершение аукциона |

---

## Лицензия

MIT
