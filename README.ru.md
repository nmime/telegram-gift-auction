# Система аукционов Telegram Gift

**Продакшен-ready платформа многораундовых аукционов для цифровых коллекционных предметов, созданная для экосистемы Telegram.**

[![Демо](https://img.shields.io/badge/Демо-funfiesta.games-blue?style=for-the-badge)](https://telegram-gift-auction.funfiesta.games)
[![Telegram Бот](https://img.shields.io/badge/Telegram-@tggiftauctionbot-0088cc?style=for-the-badge&logo=telegram)](https://t.me/tggiftauctionbot)
[![Mini App](https://img.shields.io/badge/Mini%20App-Открыть-green?style=for-the-badge)](https://t.me/tggiftauctionbot/app)
[![API Docs](https://img.shields.io/badge/API-Swagger-orange?style=for-the-badge)](https://telegram-gift-auction.funfiesta.games/api/docs)

[English version](./README.md)

---

## Почему этот проект?

Это не просто демо аукциона — это **проверенная в бою, готовая к продакшену система**, созданная для решения реальных задач, которые большинство реализаций аукционов игнорируют.

### Ключевые преимущества

| Проблема | Наше решение |
|----------|--------------|
| **Race Conditions** | 5-уровневый контроль конкурентности (Redlock + Redis cooldown + MongoDB транзакции + оптимистичная блокировка + уникальные индексы) |
| **Финансовая целостность** | Атомарные операции с комплексной системой аудита — ни одна монета не потеряна и не создана из ниоткуда |
| **Снайпинг в последнюю секунду** | Механизм анти-снайпинга с прозрачным продлением раундов |
| **Масштабируемость** | Redis-адаптер позволяет горизонтальное масштабирование на несколько серверов |
| **Высокая производительность** | Ультра-быстрые Redis Lua скрипты достигают **2,500+ ставок/сек** с p99 латентностью менее 10мс |
| **Real-time UX** | WebSocket события гарантируют, что пользователь не пропустит важные обновления |
| **Нативный Telegram** | Полная интеграция: Login Widget, Mini App авторизация, уведомления бота |

### Что выделяет этот проект

- **Многораундовая система выбывания** — Не простой аукцион «кто больше заплатит», а сложная раундовая конкуренция с частичными победителями в каждом раунде
- **Финансовая модель с заморозкой баланса** — Суммы ставок сразу блокируются, предотвращая двойные траты и гарантируя, что победители могут оплатить
- **Умная симуляция ботов** — Реалистичная среда аукциона с ботами, которые адаптируют стратегию по мере развития раундов
- **Комплексное нагрузочное тестирование** — Проверено на 300+ одновременных запросах, 100 одновременных пользователях и сложных race conditions
- **Продакшен инфраструктура** — Docker Compose с MongoDB replica sets, Redis persistence и health checks

---

## Основные функции

### Движок аукционов
- Многораундовые аукционы с выбыванием (например, 10 предметов распределяются как 3+5+2 по 3 раундам)
- Модель одной ставки на пользователя — ставки можно только увеличивать, но не уменьшать
- Анти-снайпинг защита с настраиваемым окном и лимитом продлений
- Автоматический переход раундов с определением победителей
- Разрешение ничьих по времени первой ставки

### Конкурентность и безопасность
- **Распределённая блокировка** через Redlock (fail-fast режим, TTL 10с)
- **Redis cooldown** предотвращает спам ставками (1с на пользователя на аукцион)
- **MongoDB транзакции** со snapshot isolation и автоматическим retry
- **Оптимистичная блокировка** с проверкой версий на всех финансовых операциях
- **Уникальные индексы** обеспечивают одну активную ставку на пользователя и уникальные суммы ставок

### Ультра-быстрые ставки (Redis Path)
- **Единый Lua скрипт** выполняет ВСЮ валидацию + размещение ставки атомарно (~2мс латентность)
- **Кэшированные метаданные аукциона** исключают запросы к MongoDB на каждую ставку
- **Eager warmup пользователей** при старте аукциона загружает всех с балансом > 0
- **ZSET лидерборды** с закодированными scores для разрешения ничьих (O(log N) операции)
- **Фоновая синхронизация** записывает dirty данные в MongoDB каждые 5 секунд
- **Fallback режим** использует стандартный MongoDB путь, если кэш не готов

### Real-time коммуникация
- WebSocket события: `new-bid`, `auction-update`, `anti-sniping`, `round-complete`
- 2-минутное сохранение сессии после отключения
- Автоматический rejoin в комнату при переподключении
- Redis-адаптер для multi-server deployments

### Интеграция с Telegram
- **Login Widget** авторизация с валидацией хеша
- **Mini App (TWA)** поддержка с валидацией initData
- **Уведомления бота** через GrammyJS (оповещения о перебитии ставки, результаты раунда, анти-снайпинг)
- Локализованные сообщения (английский и русский)

### Финансовая система
- Раздельный учёт `balance` и `frozenBalance`
- Полный audit trail транзакций с before/after снэпшотами
- Endpoint проверки целостности системы
- Функционал пополнения/вывода средств

### Developer Experience
- Автогенерируемый TypeScript SDK через Nestia
- Swagger/OpenAPI документация
- Комплексный набор нагрузочных тестов (11 сценариев)
- Docker Compose для мгновенного локального запуска

---

## Технологический стек

| Уровень | Технология | Почему |
|---------|------------|--------|
| **Runtime** | Node.js 22+ | Последний LTS с современными async фичами |
| **Framework** | NestJS 11 + Fastify | 2-3x пропускная способность vs Express |
| **Язык** | TypeScript (strict) | Типобезопасность для финансовых операций |
| **База данных** | MongoDB 8.2+ | Транзакции, гибкие схемы, replica sets |
| **Кэш/Блокировки** | Redis + Redlock | Распределённая блокировка для конкурентности |
| **Real-time** | Socket.IO + Redis adapter | Масштабируемая WebSocket коммуникация |
| **Авторизация** | JWT Bearer tokens | Stateless, distributed-friendly |
| **Telegram** | GrammyJS | Современный Telegram бот фреймворк |
| **Frontend** | React 19 + Vite | Быстрая разработка, современный тулинг |
| **Валидация** | class-validator + Joi | Комплексная валидация входных данных |

---

## Архитектура

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Frontend (React + Vite)                      │
│  - Список и детали аукционов    - Обновления ставок в реальном времени│
│  - Размещение/увеличение ставок - Управление балансом               │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Backend (NestJS + Fastify)                      │
│                                                                      │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌──────────────┐  │
│  │  REST API  │  │  WebSocket │  │  Scheduler │  │    Guards    │  │
│  │ (Fastify)  │  │ (Socket.IO)│  │   (Cron)   │  │ (Auth/Rate)  │  │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └──────┬───────┘  │
│        │               │               │                 │          │
│        ▼               ▼               ▼                 ▼          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      Сервисный слой                          │  │
│  │                                                               │  │
│  │  AuctionsService          UsersService         BotService    │  │
│  │  ├─ placeBid()            ├─ deposit()         ├─ simulate() │  │
│  │  ├─ placeBidFast()        ├─ withdraw()        └─ bid()      │  │
│  │  ├─ completeRound()       └─ getBalance()                    │  │
│  │  ├─ antiSniping()                                            │  │
│  │  └─ getLeaderboard()                                         │  │
│  │                                                               │  │
│  │  TransactionsService      EventsGateway                      │  │
│  │  ├─ recordTransaction()   ├─ emitNewBid()                    │  │
│  │  └─ getHistory()          ├─ emitRoundComplete()             │  │
│  │                           └─ emitAntiSniping()               │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                    │                                │
└────────────────────────────────────┼────────────────────────────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              ▼                      ▼                      ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────┐
│       MongoDB       │  │        Redis        │  │                 │
│                     │  │                     │  │                 │
│  users              │  │  Распределённые     │  │    WebSocket    │
│  ├─ balance         │  │  блокировки         │  │    Клиенты      │
│  └─ frozenBalance   │  │  (Redlock)          │  │                 │
│                     │  │                     │  │                 │
│  auctions           │  │  Bid Cache (Lua)    │  │                 │
│  ├─ roundsConfig[]  │  │  ├─ balances        │  │                 │
│  └─ rounds[]        │  │  ├─ leaderboard     │  │                 │
│                     │  │  └─ dirty tracking  │  │                 │
│  bids               │  │                     │  │                 │
│  ├─ amount          │  │  Кулдаун ставок     │  │                 │
│  └─ status          │  │  (на пользователя)  │  │                 │
│                     │  │                     │  │                 │
│  transactions       │  │  Cache Sync (5s)    │  │                 │
│  └─ аудит           │  │  └─ MongoDB writes  │  │                 │
└─────────────────────┘  └─────────────────────┘  └─────────────────┘
```

---

## Как это работает

### Жизненный цикл аукциона

```
PENDING ──[старт]──► ACTIVE ──[раунды завершены]──► COMPLETED
                        │
                        ├── Раунд 1: Топ 3 выигрывают предметы #1-3
                        ├── Раунд 2: Топ 5 выигрывают предметы #4-8
                        └── Раунд 3: Топ 2 выигрывают предметы #9-10
                                     │
                                     └── Оставшиеся ставки возвращаются
```

### Поток ставки (5-уровневая защита)

```typescript
POST /api/auctions/:id/bid { amount: 1000 }

// 1. Распределённая блокировка (Redlock)
→ Захват блокировки для пользователь+аукцион (fail-fast, TTL 10с)

// 2. Redis Cooldown
→ Проверка 1-секундного кулдауна между ставками

// 3. MongoDB транзакция (Snapshot Isolation)
→ Старт транзакции с majority write concern

// 4. Оптимистичная блокировка
→ Проверка что user.version и bid.__v соответствуют ожидаемым значениям

// 5. Уникальный индекс
→ База отклоняет дублирующие ставки пользователя или суммы

// При успехе:
→ Коммит транзакции, установка кулдауна, освобождение блокировки, WebSocket событие
```

### Ультра-быстрый поток ставки (Единый Redis вызов)

```typescript
POST /api/auctions/:id/fast-bid { amount: 1000 }

// 1. Единый вызов Lua скрипта (ВСЯ валидация + размещение)
→ Проверка статуса аукциона из кэша (ACTIVE, не завершён)
→ Проверка тайминга текущего раунда (не истёк)
→ Проверка баланса пользователя из Redis hash
→ Проверка amount >= minBidAmount
→ Обработка существующей ставки (возврат замороженных средств при повышении)
→ Атомарная заморозка новой суммы
→ Обновление ZSET лидерборда с закодированным score
→ Пометка баланса и ставки как dirty для синхронизации
→ Возврат успеха с предыдущей/новой суммой

// 2. Асинхронные операции (неблокирующие)
→ WebSocket событие new-bid
→ Проверка окна анти-снайпинга (продление раунда при необходимости)
→ Отправка уведомлений о перебитии вытесненным пользователям

// 3. Фоновая синхронизация (каждые 5 секунд)
→ CacheSyncService записывает dirty данные в MongoDB
→ Использует bulk операции для эффективности

// Результат: ~2мс латентность, 2,500+ ставок/сек
```

### Анти-снайпинг защита

```
Конец раунда: 10:00:00
Окно анти-снайпинга: 5 минут
Продление: 5 минут
Макс. продлений: 6

Таймлайн:
  09:54:59 - Ставка → Без продления (вне окна)
  09:55:01 - Ставка → Раунд продлён до 10:05:00 (продление #1)
  10:04:30 - Ставка → Раунд продлён до 10:10:00 (продление #2)
  ... до 6 продлений максимум
```

### Финансовая модель

```
Баланс пользователя:
  ├── balance (доступно для ставок)
  └── frozenBalance (заблокировано в активных ставках)

Инвариант: Общая стоимость = balance + frozenBalance + потрачено на победы

Жизненный цикл ставки:
  Размещение:  balance -= amount,  frozenBalance += amount
  Победа:      frozenBalance -= amount  (деньги потрачены)
  Возврат:     frozenBalance -= amount, balance += amount (деньги возвращены)
```

---

## Результаты нагрузочного тестирования

Система включает комплексный набор тестов, проверяющих поведение под нагрузкой.

### Сравнение производительности: Стандартная vs Быстрая ставка

Система поддерживает два режима:
- **Стандартная ставка**: MongoDB транзакции с полными ACID гарантиями
- **Ультра-быстрая ставка**: Единый Redis Lua скрипт выполняет ВСЮ валидацию + размещение атомарно

| Метрика | Стандартная | Ультра-быстрая (Redis) | Улучшение |
|---------|-------------|------------------------|-----------|
| **Concurrent Storm (50 юзеров)** | 11.5 req/s, p99=4.3s | 2,452 req/s, p99=19ms | **213x быстрее** |
| **Последовательные ставки** | avg 16ms | avg 2ms | **8x быстрее** |
| **Массовая конкурентность (150)** | 18.5 req/s, p99=2.6s | 438 req/s, p99=12ms | **24x быстрее** |
| **E2E конкурентная пропускная способность** | — | 5,556 ставок/сек | — |
| **Raw Lua Script пропускная способность** | — | 58,824 ops/sec | — |

### Запуск нагрузочных тестов

```bash
# Стандартный режим
cd backend && npm run load-test

# Быстрый режим (Redis path)
cd backend && npm run load-test -- --fast

# Тяжёлый стресс-тест с 100 пользователями
npm run load-test -- --fast --users 100 --deposit 100000 --stress-duration 10000
```

### Результаты ультра-быстрых тестов

```
══════════════════════════════════════════════════
   AUCTION SYSTEM LOAD TEST SUITE v1.0.0
══════════════════════════════════════════════════
Fast Bid:  ENABLED (Ultra-fast Redis path)
══════════════════════════════════════════════════

✓ Concurrent Bid Storm: 50/50 @ 2,452 req/s, p99=19ms
✓ Rapid Sequential Bids: 20/20, avg=2ms
✓ High-Frequency Stress: 88 bids @ 17.4 req/s
✓ Massive Concurrent Stress: 150/150 @ 438 req/s, p99=12ms
✓ Same-User Race Condition: 0/10 succeeded (expected <10)
✓ Bid Ordering Verification: ordering=correct
✓ Financial Integrity: VALID (diff=0.00)

══════════════════════════════════════════════════
  ALL TESTS PASSED
══════════════════════════════════════════════════
```

---

## Быстрый старт

### Вариант 1: Docker Compose (Рекомендуется)

```bash
# Настроить окружение
cp backend/.env.example backend/.env
cp frontend/.env.example frontend/.env

# Запустить всё
docker compose up --build

# Доступ:
# - Frontend: http://localhost:5173
# - Backend API: http://localhost:4000/api
# - Swagger Docs: http://localhost:4000/api/docs
```

### Вариант 2: Локальная разработка

```bash
# Запустить только инфраструктуру
docker compose -f docker-compose.infra.yml up -d

# Установить и запустить
npm install
npm run dev

# Или запустить отдельно:
npm run dev:backend   # http://localhost:4000
npm run dev:frontend  # http://localhost:5173
```

### Вариант 3: Ручная настройка

**Требования:** Node.js 22+, MongoDB 8.2+ (replica set), Redis 7+

```bash
# Backend
cd backend && npm install && npm run start:dev

# Frontend (другой терминал)
cd frontend && npm install && npm run dev
```

---

## API справочник

### Аутентификация

Все защищённые эндпоинты требуют заголовок `Authorization: Bearer <token>`.

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/auth/telegram/webapp` | POST | Авторизация через Mini App initData |
| `/api/auth/telegram/widget` | POST | Авторизация через Login Widget |
| `/api/auth/me` | GET | Получить текущего пользователя |
| `/api/auth/refresh` | POST | Обновить JWT токен |

### Аукционы

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/auctions` | GET | Список аукционов |
| `/api/auctions` | POST | Создать аукцион |
| `/api/auctions/:id` | GET | Детали аукциона |
| `/api/auctions/:id/start` | POST | Запустить аукцион |
| `/api/auctions/:id/bid` | POST | Сделать или увеличить ставку (стандартный путь) |
| `/api/auctions/:id/fast-bid` | POST | Разместить ставку через Redis (высокая производительность) |
| `/api/auctions/:id/leaderboard` | GET | Текущий рейтинг |
| `/api/auctions/:id/min-winning-bid` | GET | Минимальная ставка для победы |

### Пользователи и транзакции

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/users/balance` | GET | Получить баланс (доступный + замороженный) |
| `/api/users/deposit` | POST | Пополнить |
| `/api/users/withdraw` | POST | Вывести средства |
| `/api/transactions` | GET | История транзакций |

### WebSocket события

**Клиент → Сервер:**
- `join-auction` - Подписка на обновления аукциона
- `leave-auction` - Отписка

**Сервер → Клиент:**
- `new-bid` - Новая ставка
- `auction-update` - Изменение состояния аукциона
- `anti-sniping` - Раунд продлён
- `round-complete` - Раунд завершён с победителями
- `auction-complete` - Аукцион завершён
- `round-start` - Начался новый раунд

---

## Конфигурация

### Backend (`backend/.env`)

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `PORT` | Порт сервера | 4000 |
| `MONGODB_URI` | Строка подключения MongoDB | — |
| `REDIS_URL` | Строка подключения Redis | — |
| `JWT_SECRET` | Секрет для подписи JWT | (обязателен) |
| `TELEGRAM_BOT_TOKEN` | Токен Telegram бота | — |
| `CORS_ORIGIN` | Разрешённый CORS origin | http://localhost:5173 |

### Frontend (`frontend/.env`)

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `VITE_API_URL` | URL Backend API | http://localhost:4000/api |
| `VITE_SOCKET_URL` | URL WebSocket сервера | http://localhost:4000 |

### Rate Limiting (Три уровня)

- **Short**: 20 запросов/секунду
- **Medium**: 100 запросов/10 секунд
- **Long**: 300 запросов/минуту

Localhost обходит rate limiting для разработки.

---

## Структура проекта

```
.
├── backend/
│   ├── src/
│   │   ├── common/          # Guards, errors, types
│   │   ├── config/          # Конфигурация и валидация env
│   │   ├── modules/
│   │   │   ├── auctions/    # Основная логика аукционов (1000+ строк)
│   │   │   ├── auth/        # JWT + Telegram авторизация
│   │   │   ├── bids/        # Запросы ставок
│   │   │   ├── events/      # WebSocket gateway
│   │   │   ├── redis/       # Redis клиент + Redlock + Bid Cache
│   │   │   ├── telegram/    # Интеграция бота
│   │   │   ├── transactions/# Финансовый аудит
│   │   │   └── users/       # Управление пользователями
│   │   ├── schemas/         # MongoDB схемы
│   │   └── scripts/         # Нагрузочное тестирование
│   ├── Dockerfile
│   └── .env.example
├── frontend/
│   ├── src/
│   │   ├── api/             # API клиент
│   │   ├── components/      # UI компоненты
│   │   ├── context/         # Auth & notifications
│   │   ├── hooks/           # useSocket, useCountdown
│   │   ├── i18n/            # Переводы (en/ru)
│   │   ├── pages/           # Страницы роутов
│   │   └── types/           # TypeScript интерфейсы
│   ├── Dockerfile
│   └── .env.example
├── docker-compose.yml       # Полный стек
├── docker-compose.infra.yml # Только инфраструктура
└── README.md
```

---

## Обработанные краевые случаи

| Краевой случай | Решение |
|----------------|---------|
| Ставка в момент конца раунда | Буфер 100мс отклоняет «слишком близкие» ставки |
| Ставка во время перехода раунда | Изоляция транзакции предотвращает устаревшие чтения |
| Падение сервера во время ставки | MongoDB транзакция откатывается; Redis блокировка истекает |
| 10 конкурентных ставок от одного пользователя | Redlock обеспечивает выполнение только 1; остальные fail fast |
| Race condition одинаковых сумм | Уникальный индекс + семантика first-write-wins |
| Баланс уходит в минус | Валидация схемы (`min: 0`) + атомарная проверка `$gte` |
| Раунд завершается без ставок | Корректный переход к следующему раунду или завершение аукциона |
| WebSocket отключение посреди аукциона | 2-минутное сохранение сессии + auto-rejoin |

---

## Дизайн-решения

**Почему MongoDB транзакции?**
Финансовые операции требуют атомарности. Если списание баланса успешно, а создание ставки нет — система теряет деньги.

**Почему Redis + Redlock?**
MongoDB транзакции обрабатывают конкурентность на уровне базы, но не предотвращают отправку 10 конкурентных HTTP запросов одним пользователем.

**Почему Fastify вместо Express?**
2-3x лучшая пропускная способность и нативная поддержка TypeScript — критично для сценариев с высокой конкурентностью.

**Почему уникальные суммы ставок?**
Одинаковые суммы создают неоднозначность в рейтинге. Уникальные суммы (на аукцион) обеспечивают детерминированную таблицу лидеров.

**Почему запланированное завершение раундов?**
Cron-задача (каждые 5с) обеспечивает завершение раундов даже без подключённых клиентов и корректно обрабатывает перезапуски сервера.

**Почему Redis Lua скрипты для ультра-быстрых ставок?**
MongoDB транзакции добавляют ~50-100мс латентности под конкурентной нагрузкой из-за блокировок. Наш ультра-быстрый Lua скрипт выполняет ВСЮ валидацию (статус аукциона, тайминг раунда, проверка баланса) и размещение ставки за один атомарный вызов (~0.02мс), обеспечивая 2,500+ ставок/сек с консистентностью через периодическую синхронизацию.

**Почему единый Lua скрипт вместо нескольких вызовов?**
Каждый round-trip до Redis добавляет ~1-2мс сетевой латентности. Объединив проверку метаданных аукциона, валидацию баланса, размещение ставки и обновление лидерборда в один скрипт, мы исключаем 3-4 round-trip'а и достигаем 3x лучшей пропускной способности по сравнению с многовызовным подходом.

**Почему фоновая синхронизация вместо Write-Through?**
Real-time запись в MongoDB нивелирует преимущества скорости. 5-секундный интервал синхронизации обеспечивает отличную durability (макс. 5 сек потери данных при катастрофическом сбое) при сохранении латентности ставки менее 2мс.

**Почему eager warmup пользователей?**
Ленивая загрузка кэша (прогрев пользователей при первой ставке) добавляет 5-10мс латентности первому участнику. Eager warmup при старте аукциона предзагружает всех пользователей с положительным балансом, обеспечивая стабильную латентность менее 2мс для всех.

---

## Лицензия

MIT
